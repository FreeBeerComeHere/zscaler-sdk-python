# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: ZIA Test
on:
    pull_request:
      types: [opened, synchronize]
    merge_group:
      types: [checks_requested]
    push:
      branches:
        - master
    schedule:
      - cron: '0 14 * * 1-5' # UTC
    workflow_dispatch:
  

jobs:
    zia-beta-tenants:
        runs-on: ubuntu-latest
        strategy:
          fail-fast: false
          matrix:
            python-version: ["3.10"]
            environment:
                - ZIA_ZSBETA
        environment: ${{ matrix.environment }}
        steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
              token: ${{ secrets.GITHUB_TOKEN }} 

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                python-version: ${{ matrix.python-version }}

            - name: Cache Python dependencies
              uses: actions/cache@v4
              with:
                path: |
                  ~/.cache/pip
                  !~/.cache/pip/log
                key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/setup.py') }}
                restore-keys: |
                  ${{ runner.os }}-pip-

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                python -m pip install flake8 pytest pytest-cov
                if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            - name: Lint with flake8
              run: |
                make lint:zia

            - name: Run Pytest
              uses: nick-fields/retry@v3
              with:
                max_attempts: 3
                timeout_minutes: 45
                command: |
                    make coverage:zia
              env:
                ZIA_USERNAME: ${{ secrets.ZIA_USERNAME }}
                ZIA_PASSWORD: ${{ secrets.ZIA_PASSWORD }}
                ZIA_API_KEY: ${{ secrets.ZIA_API_KEY }}
                ZIA_CLOUD: ${{ secrets.ZIA_CLOUD }}
                ZIA_SANDBOX_TOKEN: ${{ secrets.ZIA_SANDBOX_TOKEN }}
                ZPA_CLIENT_ID: ${{ secrets.ZPA_CLIENT_ID }}
                ZPA_CLIENT_SECRET: ${{ secrets.ZPA_CLIENT_SECRET }}
                ZPA_CUSTOMER_ID: ${{ secrets.ZPA_CUSTOMER_ID }}
                ZPA_CLOUD: ${{ secrets.ZPA_CLOUD }}

    zia-test-tenants:
        runs-on: ubuntu-latest
        strategy:
          fail-fast: false
          matrix:
            python-version: ["3.10"]
            environment:
              - ZIA_ZSCLOUD
              - ZIA_ZS0
              - ZIA_ZS1
              - ZIA_ZS2
              - ZIA_ZS3
        environment: ${{ matrix.environment }}
        steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
              token: ${{ secrets.GITHUB_TOKEN }} 

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                python-version: ${{ matrix.python-version }}
 
            - name: Cache Python dependencies
              uses: actions/cache@v4
              with:
                path: |
                  ~/.cache/pip
                  !~/.cache/pip/log
                key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/setup.py') }}
                restore-keys: |
                  ${{ runner.os }}-pip-

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                python -m pip install flake8 pytest pytest-cov
                if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            - name: Lint with flake8
              run: |
                make lint:zia
        
            - name: Run Pytest
              uses: nick-fields/retry@v3
              with:
                max_attempts: 3
                timeout_minutes: 45
                command: |
                    make coverage:zia
              env:
                ZIA_USERNAME: ${{ secrets.ZIA_USERNAME }}
                ZIA_PASSWORD: ${{ secrets.ZIA_PASSWORD }}
                ZIA_API_KEY: ${{ secrets.ZIA_API_KEY }}
                ZIA_CLOUD: ${{ secrets.ZIA_CLOUD }}
                ZIA_SANDBOX_TOKEN: ${{ secrets.ZIA_SANDBOX_TOKEN }}
                ZPA_CLIENT_ID: ${{ secrets.ZPA_CLIENT_ID }}
                ZPA_CLIENT_SECRET: ${{ secrets.ZPA_CLIENT_SECRET }}
                ZPA_CUSTOMER_ID: ${{ secrets.ZPA_CUSTOMER_ID }}
                ZPA_CLOUD: ${{ secrets.ZPA_CLOUD }}
